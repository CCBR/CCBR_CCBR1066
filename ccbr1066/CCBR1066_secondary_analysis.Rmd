---
title: "CCBR1066- Secondary Analysis"
author: "Samantha Sevilla, [CCBR]"
output: html_notebook
editor_options: 
  chunk_output_type: console
output: 
  html_document:
    toc: true
    toc_float: true
---
# Code info
Runs GSEA and ORA with Pipeliner Output for Human data
Developed from code by Vishal Koparde

```{r include=FALSE}
library("tidyverse")
library("stats")
library("affy")
library("DESeq2")
library("edgeR")
library("DT")
library("ggplot2")
library("EnhancedVolcano")
library("msigdbr")
library("enrichplot")
library("clusterProfiler")
library("ggpubr")
```

######################################################################
# Functions
######################################################################
```{r functions, include=FALSE}
readdegfile<-function(fn){
  x=read.csv(fn,header=TRUE,sep="\t")
  return(as.data.frame(x))
}
deg2geneList<-function(deg){
  gl=as.data.frame(deg$gsea_ranking_score)
  gl$GN=deg$gene
  colnames(gl)=c("Rank","GeneName")
  gl$absRank=abs(gl$Rank)
  gl=gl[order(gl$absRank,decreasing = TRUE),]
  gl=gl[match(unique(gl$GeneName),gl$GeneName),]
  geneList=gl$Rank
  names(geneList)=as.character(gl$GeneName)
  geneList <- sort(geneList, decreasing = TRUE)
  return(geneList)
}

gsea_plus_plot <- function(gl,t2g,ttl,fn){
  result=GSEA(geneList = gl,TERM2GENE = t2g,eps = 0)
  resultdf=as.data.frame(result)
  write.table(resultdf,file=fn,quote=FALSE,sep="\t",row.names = FALSE,col.names = TRUE)
  
  if(nrow(result)==0){
    print("No sig results for GSEA")
    p1 = ggparagraph(
      paste0("\n\n\n No Sig Results"),
      color = NULL,
      size = 20,
      face = "bold",
      family = NULL,
      lineheight = NULL
    )
  } else{
    p1 = dotplot(result,title=ttl,font.size = 8, showCategory=10)
  }
  
  return(p1)
}

ora_plus_plot <- function(gl,t2g,ttl,fn){
  result=enricher(gene=gl,TERM2GENE=t2g,pvalueCutoff = 0.1)
  
  if(nrow(result)==0){
    print("No sig results for ORA")
    p1 = ggparagraph(
      paste0("\n\n\n No Sig Results"),
      color = NULL,
      size = 20,
      face = "bold",
      family = NULL,
      lineheight = NULL
    )
  } else{
    p1 = dotplot(result,title=ttl,font.size = 8, showCategory=10)
  }
  return(p1)
}

save_plots<-function(p1,p2,contrast_id,file_name){
  mypdf <- cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])
  print(mypdf)
  ggsave(filename = paste(out_dir, contrast_id, "/", contrast_id, file_name, sep=""), 
         height = 8.90, width = 12.80, device = "pdf", plot = mypdf)  
}
```

######################################################################
# main code
######################################################################
```{r}
main_function<-function(deg_file,out_dir,contrast_id){
  
  # read deg
  deg=readdegfile(deg_file)
  
  #create output dir if needed
  dir.create(file.path(out_dir), showWarnings = FALSE)

  #subset significant genes for GSEA
  siggenes=deg[deg$fdr <= p_val & (deg$fc < (-1*fc) | deg$fc > fc),]
  sigGeneList=siggenes$gene
  
  #set genelist for ORA
  geneList=deg2geneList(deg)
  
  #generate gene lists for C2 with subtypes biocarta, kegg, reactome, wiki
  c2b=msigdbr(species = species, category = "C2", subcategory = "BIOCARTA") %>% 
    dplyr::select(gs_name,gene_symbol)
  
  c2k=msigdbr(species = species, category = "C2", subcategory = "KEGG") %>% 
    dplyr::select(gs_name,gene_symbol)
  
  c2r=msigdbr(species = species, category = "C2", subcategory = "REACTOME") %>%
    dplyr::select(gs_name,gene_symbol)
  
  c2w=msigdbr(species = species, category = "C2", subcategory = "WIKIPATHWAYS") %>%
    dplyr::select(gs_name,gene_symbol)
  
  #generate gene lists for C5 with subtypes MF, BP, CC
  c5gomf=msigdbr(species = species,  category = "C5", subcategory = "GO:MF") %>% dplyr::select(gs_name,gene_symbol)
  c5gobp=msigdbr(species = species,  category = "C5", subcategory = "GO:BP") %>% dplyr::select(gs_name,gene_symbol)
  c5gocc=msigdbr(species = species,  category = "C5", subcategory = "GO:CC") %>% dplyr::select(gs_name,gene_symbol)

  ## C2:BIOCARTA
  print("Results for BIOCARTA")
  p1 = gsea_plus_plot(gl=geneList,t2g=c2b,ttl="GSEA:C2:BIOCARTA",
                      fn=paste(out_dir,contrast_id,".c2b.gsea.results.txt",sep=""))
  p2 = ora_plus_plot(gl=sigGeneList,t2g=c2b,ttl="ORA:C2:BIOCARTA",
                     fn=paste(out_dir,contrast_id,".c2b.ora.results.txt",sep=""))
  save_plots(p2,p1,contrast_id,".c2b.dotplot.pdf")
  
  ## C2:KEGG
  print("Results for KEGG")
  p1 = gsea_plus_plot(gl=geneList,t2g=c2k,ttl="GSEA:C2:KEGG",
                      fn=paste(out_dir,contrast_id,".c2k.gsea.results.txt",sep=""))
  p2 = ora_plus_plot(gl=sigGeneList,t2g=c2k,ttl="ORA:C2:KEGG",
                     fn=paste(out_dir,contrast_id,".c2k.ora.results.txt",sep=""))
  save_plots(p2,p1,contrast_id,".c2k.dotplot.pdf")

  ## C2:REACTOME
  print("Results for REACTOME")
  p1 = gsea_plus_plot(gl=geneList,t2g=c2r,ttl="GSEA:C2:REACTOME",
                      fn=paste(out_dir,contrast_id,".c2r.gsea.results.txt",sep=""))
  p2 = ora_plus_plot(gl=sigGeneList,t2g=c2r,ttl="ORA:C2:REACTOME",
                     fn=paste(out_dir,contrast_id,".c2r.ora.results.txt",sep=""))
  save_plots(p2,p1,contrast_id,".c2r.dotplot.pdf")

  ## C2:WIKIPATHWAYS
  print("Results for WIKIPATHWAYS")
  p1 = gsea_plus_plot(gl=geneList,t2g=c2w,ttl="GSEA:C2:WIKIPATHWAYS",
                    fn=paste(out_dir,contrast_id,".c2w.gsea.results.txt",sep=""))
  p2 = ora_plus_plot(gl=sigGeneList,t2g=c2w,ttl="ORA:C2:WIKIPATHWAYS",
                   fn=paste(out_dir,contrast_id,".c2w.ora.results.txt",sep=""))
  save_plots(p2,p1,contrast_id,".c2w.dotplot.pdf")

  ## C5:GO:MF
  print("Results for GO:MF")
  p1 = gsea_plus_plot(gl=geneList,t2g=c5gomf,ttl="GSEA:GO:MF",
                    fn=paste(out_dir,contrast_id,".c5gomf.gsea.results.txt",sep=""))
  p2 = ora_plus_plot(gl=sigGeneList,t2g=c5gomf,ttl="ORA:GO:MF",
                   fn=paste(out_dir,contrast_id,".c5gomf.ora.results.txt",sep=""))
  save_plots(p2,p1,contrast_id,".c5gomf.dotplot.pdf")

  ## C5:GO:BP
  print("Results for GO:BP")
  p1 = gsea_plus_plot(gl=geneList,t2g=c5gobp,ttl="GSEA:GO:BP",
                    fn=paste(out_dir,contrast_id,".c5gobp.gsea.results.txt",sep=""))
  p2 = ora_plus_plot(gl=sigGeneList,t2g=c5gobp,ttl="ORA:GO:BP",
                   fn=paste(out_dir,contrast_id,".c5gobp.ora.results.txt",sep=""))
  save_plots(p2,p1,contrast_id,".c5gobp.dotplot.pdf")

  ## C5:GO:CC
  print("Results for GO:CC")
  p1 = gsea_plus_plot(gl=geneList,t2g=c5gobp,ttl="GSEA:GO:CC",
                    fn=paste(out_dir,contrast_id,".c5gocc.gsea.results.txt",sep=""))
  p2 = ora_plus_plot(gl=sigGeneList,t2g=c5gobp,ttl="ORA:GO:CC",
                   fn=paste(out_dir,contrast_id,".c5gocc.ora.results.txt",sep=""))
  save_plots(p2,p1,contrast_id,".c5gocc.dotplot.pdf")
}
```

#####################################
# Run ORA/GSEA analysis
#####################################
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
  
#set global variables
p_val = 0.05
species = "Homo sapiens"
fc = 2

#paths
deg_dir = "~/../../Volumes/projects-1/ccbr1066/deg_012021/"
out_dir = "~/../../Volumes/projects-1/ccbr1066/analysis/ora_vs_gsea_test/"

#Mock vs KO
main_function(deg_file = paste0(deg_dir, "DEG_Mock-KO_0.5_0.5/limma_DEG_Mock-KO_all_genes.txt"), 
     out_dir = paste0(out_dir,"Mock.KO/"),
     contrast_id = "Mock.KO")

#WT vs KO
main_function(deg_file = paste0(deg_dir, "DEG_WT-KO_0.5_0.5/limma_DEG_WT-KO_all_genes.txt"), 
     out_dir = paste0(out_dir,"WT.KO/"),
     contrast_id = "WT.KO")

#Y318A vs KO
main_function(deg_file = paste0(deg_dir, "DEG_Y318A-KO_0.5_0.5/limma_DEG_Y318A-KO_all_genes.txt"), 
     out_dir = paste0(out_dir,"Y318A.KO/"),
     contrast_id = "Y318A.KO")

```

#####################################
# Review pathview gene lists
#####################################
```{r}
library(VennDiagram)

#read gene list for ox phos
path_df = read.csv(paste0(analysis_dir,"pathview_output/complete_mock:wt,y318A/genedata.hsa00190.tsv"),sep="\t")
head(path_df)
print(paste0("The number of genes/complexes in list is ",nrow(path_df)))
print(paste0("The number of genes/complexes downregulated is ",nrow(subset(path_df,mol.col=="#00FF00"))))
print(paste0("The number of genes/complexes upregulated is ",nrow(subset(path_df,mol.col=="#FF0000" | mol.col=="#DE9E9E"))))
print(paste0("The number of genes/complexes not diff is ",nrow(subset(path_df,mol.col=="#D3D3D3"))))
print(paste0("The number of genes/complexes missing info ",nrow(subset(path_df,mol.col=="#FFFFFF"))))

## gene list
gene_oxphos = unique(path_df$labels)

#read gene list for proteasome
path_df = read.csv(paste0(analysis_dir,"pathview_output/complete_mock:wt,y318A_proteasome/genedata.hsa03050.tsv"),sep="\t")
print(paste0("The number of genes/complexes in list is ",nrow(path_df)))
print(paste0("The number of genes/complexes downregulated is ",nrow(subset(path_df,mol.col=="#00FF00"))))
print(paste0("The number of genes/complexes upregulated is ",nrow(subset(path_df,mol.col=="#FF0000" | mol.col=="#DE9E9E"))))
print(paste0("The number of genes/complexes not diff is ",nrow(subset(path_df,mol.col=="#D3D3D3"))))
print(paste0("The number of genes/complexes missing info ",nrow(subset(path_df,mol.col=="#FFFFFF"))))
gene_prot = unique(path_df$labels)

#comparison
GenerateVennD <- function(list1,list2,list.names,list.cols,title.in,fname){
  
  venn.diagram(
    #create venn
    x=list(list1,list2),
    category.names = list.names,
    fill=list.cols,
    
    #title
    main=title.in,
    main.cex = 2,
    
    #output
    filename = fname,
    output=TRUE,
  )
}

#set dir
analysis_dir="analysis/"

#run code
file_save = (paste(analysis_dir,"images/venn_genes_pathview.png",sep=""))
color.list =  c("light blue", "pink")
GenerateVennD(gene_oxphos,gene_prot,c("Ox Phos","Proteasome"),color.list,"KEGG Gene Comparison", file_save)
```
